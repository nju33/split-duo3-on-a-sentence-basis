#!/usr/bin/env bash

set -eu

if ! command -v ffmpeg; then
    echo -e "Please install ffmpeg"
    exit 1
fi

cleanup() {
    set +e
    # delete all once created mp3s
    rm out/*.mp3
    set -e
}

extract() {
    # disc:delay:duration
    local -a data=(
        "1:3:4"
        "1:0:5"
        "1:0:7"
        "1:0:7"
        "1:0:5"
        "1:0:5"
        "1:1:7"
        "1:1:4"
        "1:0:7"
        "2:3:6"
        "2:0:7"
        "2:0:5"
        "2:0:7"
        "2:0:5"
        "2:0:6"
        "2:0:5"
        "2:1:5"
        "2:0:6"
        "2:1:6"
        "2:1:7"
        "2:0:5"
        "3:4:6"
        "3:1:6"
        "3:0:6"
        "3:0:6"
        "3:0:8"
        "3:0:5"
        "3:1:6"
        "3:0:5"
        "3:1:7"
        "3:1:4"
        "3:1:8"
        "3:0:7"
        "3:0:5"
        "3:1:6"
        "4:3:5"
        "4:0:4"
        "4:1:4"
        "4:1:5"
        "4:1:7"
        "4:1:5"
        "4:0:5"
        "4:1:7"
        "4:1:4"
        "4:1:6"
        "5:3:4"
        "5:1:5"
        "5:1:3"
        "5:1:6"
        "5:0:5"
        "5:0:4"
        "5:0:6"
        "5:0:6"
        "5:1:4"
        "5:0:5"
        "5:1:6"
        "5:0:6"
        "5:1:4"
        "5:1:3"
        "5:1:6"
        "5:0:8"
        "5:0:6"
        "6:4:5"
        "6:0:7"
        "6:0:7"
        "6:1:4"
        "6:1:5"
        "6:1:8"
        "6:1:4"
        "6:1:7"
        "6:1:4"
        "6:1:6"
        "6:0:7"
        "6:0:6"
        "6:0:7"
        "7:4:6"
        "7:0:7"
        "7:0:5"
        "7:1:4"
        "7:0:5"
        "7:1:7"
        "7:0:6"
        "7:1:5"
        "7:1:6"
        "7:1:5"
        "7:1:6"
        "7:1:6"
        "7:1:6"
        "7:1:5"
        "7:1:4"
        "7:1:6"
        "8:3:5"
        "8:0:5"
        "8:1:6"
        "8:0:5"
        "8:1:5"
        "8:0:5"
        "8:1:6"
        "8:1:3"
        "8:1:4"
        "9:4:5"
        "9:1:3"
        "9:1:4"
        "9:1:4"
        "9:0:5"
        "9:1:3"
        "9:1:5"
        "9:1:4"
        "9:1:7"
        "9:2:8"
        "9:0:6"
        "9:1:6"
        "9:0:4"
        "10:4:3"
        "10:1:5"
        "10:1:6"
        "10:1:6"
        "10:1:4"
        "10:0:6"
        "10:1:3"
        "10:1:6"
        "10:1:6"
        "10:1:5"
        "10:0:7"
        "10:0:5"
        "11:4:5"
        "11:0:6"
        "11:1:5"
        "11:1:4"
        "11:1:5"
        "11:1:5"
        "11:1:6"
        "11:1:6"
        "11:1:4"
        "11:1:6"
        "11:1:8"
        "12:3:5"
        "12:1:5"
        "12:1:5"
        "12:1:5"
        "12:1:6"
        "12:1:6"
        "12:1:3"
        "12:1:5"
        "12:1:5"
        "13:3:7"
        "13:1:2"
        "13:1:4"
        "13:1:8"
        "13:1:5"
        "13:0:4"
        "13:1:6"
        "13:1:4"
        "13:1:5"
        "13:0:8"
        "14:4:6"
        "14:1:5"
        "14:1:5"
        "14:1:3"
        "14:1:7"
        "14:1:7"
        "14:0:6"
        "14:0:5"
        "14:1:4"
        "14:1:5"
        "15:4:4"
        "15:0:6"
        "15:0:4"
        "15:0:5"
        "15:0:6"
        "15:0:8"
        "15:1:7"
        "15:1:5"
        "15:1:4"
        "15:2:4"
        "15:1:6"
        "16:3:9"
        "16:1:9"
        "16:0:8"
        "16:0:4"
        "16:1:5"
        "16:1:5"
        "16:1:5"
        "16:1:5"
        "16:1:3"
        "17:4:6"
        "17:1:9"
        "17:1:5"
        "17:1:5"
        "17:1:8"
        "17:0:4"
        "17:0:6"
        "17:1:4"
        "17:1:4"
        "17:1:5"
        "17:1:6"
        "17:1:7"
        "18:3:6"
        "18:1:6"
        "18:1:7"
        "18:0:6"
        "18:1:4"
        "18:1:6"
        "18:1:7"
        "18:0:8"
        "18:0:8"
        "18:1:7"
        "18:2:4"
        "18:1:4"
        "18:1:6"
        "18:0:9"
        "19:4:8"
        "19:1:5"
        "19:1:4"
        "19:1:7"
        "19:1:4"
        "19:1:6"
        "19:0:9"
        "19:0:5"
        "19:1:6"
        "19:1:8"
        "19:0:6"
        "19:0:5"
        "20:4:5"
        "20:0:5"
        "20:1:4"
        "20:1:5"
        "20:1:4"
        "20:0:5"
        "20:1:4"
        "20:1:4"
        "20:2:4"
        "20:1:5"
        "20:1:4"
        "20:1:4"
        "20:1:8"
        "20:1:6"
        "20:1:4"
        "20:1:6"
        "20:1:5"
        "21:4:7"
        "21:1:4"
        "21:1:4"
        "21:1:6"
        "21:1:4"
        "21:1:4"
        "21:1:4"
        "21:1:4"
        "21:2:5"
        "21:0:5"
        "21:1:7"
        "21:0:4"
        "21:1:6"
        "21:1:7"
        "21:1:6"
        "22:4:5"
        "22:1:6"
        "22:1:4"
        "22:0:5"
        "22:1:7"
        "22:1:4"
        "22:1:6"
        "22:1:5"
        "22:1:6"
        "22:1:5"
        "22:1:4"
        "22:1:6"
        "22:1:8"
        "22:1:6"
        "22:0:9"
        "22:1:5"
        "22:0:7"
        "23:4:5"
        "23:0:6"
        "23:0:4"
        "23:0:7"
        "23:1:6"
        "23:1:6"
        "23:2:8"
        "23:1:7"
        "23:1:5"
        "24:4:7"
        "24:0:6"
        "24:0:6"
        "24:1:8"
        "24:1:5"
        "24:1:5"
        "24:1:6"
        "24:1:7"
        "24:1:6"
        "24:1:6"
        "24:0:5"
        "24:1:7"
        "25:4:3"
        "25:1:7"
        "25:1:6"
        "25:1:4"
        "25:1:5"
        "25:0:5"
        "25:1:5"
        "25:1:4"
        "25:1:5"
        "25:1:4"
        "26:4:6"
        "26:0:4"
        "26:1:4"
        "26:0:6"
        "26:1:6"
        "26:1:7"
        "26:0:4"
        "26:1:5"
        "26:1:6"
        "26:0:5"
        "27:4:5"
        "27:1:5"
        "27:1:5"
        "27:0:5"
        "27:1:5"
        "27:1:3"
        "27:1:5"
        "27:1:5"
        "27:1:5"
        "27:1:5"
        "27:1:4"
        "27:1:5"
        "27:0:7"
        "27:2:5"
        "27:1:4"
        "28:4:6"
        "28:1:4"
        "28:1:6"
        "28:1:7"
        "28:0:6"
        "28:1:6"
        "28:0:7"
        "28:0:5"
        "28:1:5"
        "28:0:5"
        "28:1:4"
        "28:1:8"
        "28:1:8"
        "29:4:5"
        "29:1:5"
        "29:0:5"
        "29:0:5"
        "29:1:5"
        "29:1:4"
        "29:1:6"
        "29:1:7"
        "29:0:4"
        "29:1:5"
        "29:1:4"
        "29:1:5"
        "30:4:6"
        "30:1:9"
        "30:1:5"
        "30:0:5"
        "30:1:6"
        "30:1:7"
        "30:0:7"
        "30:1:5"
        "30:1:8"
        "30:0:4"
        "30:2:5"
        "30:0:9"
        "31:4:6"
        "31:1:5"
        "31:1:7"
        "31:0:6"
        "31:0:5"
        "31:1:5"
        "31:1:5"
        "31:1:5"
        "31:2:6"
        "31:1:5"
        "31:1:4"
        "31:0:7"
        "31:0:8"
        "31:2:5"
        "31:1:6"
        "31:1:5"
        "31:2:5"
        "32:3:5"
        "32:0:6"
        "32:1:5"
        "32:1:5"
        "32:1:5"
        "32:1:6"
        "32:1:4"
        "32:1:5"
        "32:1:5"
        "32:2:4"
        "33:4:4"
        "33:1:6"
        "33:1:8"
        "33:1:6"
        "33:1:4"
        "33:2:8"
        "33:2:5"
        "33:1:6"
        "33:2:5"
        "33:1:5"
        "33:2:5"
        "34:4:7"
        "34:1:8"
        "34:0:5"
        "34:1:5"
        "34:1:5"
        "34:0:8"
        "34:0:6"
        "34:1:6"
        "34:1:5"
        "34:0:6"
        "34:0:5"
        "34:1:5"
        "34:0:5"
        "34:1:6"
        "34:1:6"
        "35:4:5"
        "35:1:5"
        "35:1:4"
        "35:2:4"
        "35:2:4"
        "35:2:5"
        "35:1:7"
        "35:2:4"
        "35:1:6"
        "35:1:4"
        "35:1:3"
        "35:2:5"
        "35:1:6"
        "35:2:4"
        "36:4:4"
        "36:1:5"
        "36:1:4"
        "36:1:5"
        "36:0:5"
        "36:0:8"
        "36:1:5"
        "36:1:4"
        "36:1:7"
        "36:1:4"
        "36:0:5"
        "36:1:6"
        "36:1:4"
        "36:1:4"
        "36:1:6"
        "36:1:4"
        "37:4:7"
        "37:0:6"
        "37:1:6"
        "37:1:4"
        "37:1:7"
        "37:2:3"
        "37:2:5"
        "37:1:5"
        "38:4:3"
        "38:1:5"
        "38:1:5"
        "38:1:6"
        "38:0:5"
        "38:1:6"
        "38:2:5"
        "38:1:4"
        "38:1:5"
        "39:4:9"
        "39:0:4"
        "39:2:4"
        "39:1:5"
        "39:1:5"
        "39:2:4"
        "39:2:6"
        "39:2:6"
        "39:1:6"
        "39:1:5"
        "39:1:4"
        "40:4:5"
        "40:0:5"
        "40:1:6"
        "40:1:4"
        "40:1:5"
        "40:1:4"
        "40:1:6"
        "40:0:6"
        "40:1:4"
        "40:0:7"
        "40:0:5"
        "40:1:6"
        "40:1:6"
        "40:0:6"
        "40:1:6"
        "41:5:5"
        "41:0:7"
        "41:1:5"
        "41:0:4"
        "41:1:4"
        "41:1:4"
        "41:1:5"
        "41:1:4"
        "41:1:4"
        "41:1:4"
        "41:2:4"
        "41:1:4"
        "41:0:7"
        "41:1:5"
        "41:1:6"
        "42:4:5"
        "42:1:6"
        "42:1:4"
        "42:0:5"
        "42:1:7"
        "42:1:4"
        "42:0:6"
        "42:0:6"
        "42:0:6"
        "42:1:6"
        "42:1:4"
        "43:4:6"
        "43:1:5"
        "43:1:7"
        "43:1:5"
        "43:1:6"
        "43:2:5"
        "43:1:6"
        "43:1:4"
        "43:1:6"
        "43:2:4"
        "43:2:10"
        "43:1:8"
        "43:1:4"
        "44:5:5"
        "44:1:4"
        "44:0:5"
        "44:0:7"
        "44:1:7"
        "44:1:5"
        "44:0:11"
        "44:1:8"
        "44:1:7"
        "44:2:4"
        "44:1:9"
        "44:0:5"
        "44:1:3"
        "44:1:9"
        "44:1:6"
        "44:1:5"
        "44:0:4"
        "45:5:4"
        "45:1:5"
        "45:1:6"
        "45:2:4"
        "45:2:7"
        "45:0:5"
        "45:2:7"
        "45:0:4"
        "45:1:8"
        "45:1:6"
        "45:1:6"
        "45:0:6"
        "45:0:6"
    )
    local -i sum=0
    local -r lyrics_file="lyrics.txt"

    for ((i = 0; i < ${#data[@]}; ++i)); do
        {
            IFS=":"
            # shellcheck disable=SC2086
            set -- ${data[$i]}
        }
        local -i disc="$1"
        local -i track="$((i + 1))"
        local -i delay="$2"
        sum=$((sum + delay))

        local -i current="$3"

        local -A ss=(
            ["hour"]=$(printf "%02d" $((sum / 3600)))
            ["minute"]=$(printf "%02d" $((sum / 60 % 60)))
            ["second"]=$(printf "%02d" $((sum % 60)))
        )
        local lyrics
        lyrics="$(sed -n $((i + 1))p ${lyrics_file})"

        local output # e.g. 001.mp3
        output="out/$(printf "%03d" $((i + 1))).mp3"

        (
            set -x
            # ffmpeg -i in.mp3 -i artwork.png -map 0:a -map 1:v -c:v:1 png -c copy -disposition:1 attached_pic -id3v2_version 3 \
            ffmpeg -i in.mp3 -i artwork.png -acodec copy \
                -loglevel warning \
                -metadata "title"="$lyrics" \
                -metadata "disc"="$disc" \
                -metadata "track"="$track" \
                `# not working` \
                -metadata "lyrics"="$lyrics" \
                `# For Meta app used to the below tag but itâ€™s not working` \
                -metadata "lyrics-XXX"="$lyrics" \
                -metadata "comments"="$lyrics" \
                -ss "${ss["hour"]}:${ss["minute"]}:${ss["second"]}" \
                -t "${current}" \
                "$output"
        )

        sum=$((sum + current))
    done
}

cleanup
extract
